name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Lean 4
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH
        
    - name: Set Lean toolchain
      run: |
        elan toolchain install leanprover/lean4:4.8.0
        elan default leanprover/lean4:4.8.0
        
    - name: Cache Lake dependencies
      uses: actions/cache@v3
      with:
        path: |
          .lake/packages
          .lake/build
        key: ${{ runner.os }}-lake-${{ hashFiles('lakefile.lean', 'lake-manifest.json', 'lean-toolchain') }}
        restore-keys: |
          ${{ runner.os }}-lake-
          
    - name: Build project
      run: |
        lake build
        
    - name: Strict build check (Phase 5)
      run: |
        echo "Running strict Phase 5 build checks..."
        echo "1. Verifying lake manifest exists..."
        if [ ! -f "lake-manifest.json" ]; then
          echo "‚ùå lake-manifest.json missing"
          exit 1
        fi
        echo "2. Running full build verification..."
        lake build --verbose
        echo "3. Checking build status..."
        if [ $? -eq 0 ]; then
          echo "‚úÖ Build completed successfully"
        else
          echo "‚ùå Build failed"
          exit 1
        fi
        echo "4. Checking for no-sorry compliance (if [no-sorry] tag present)..."
        if [[ "${{ github.event.head_commit.message }}" == *"[no-sorry]"* ]]; then
          echo "üîç [no-sorry] tag detected - running strict check"
          if command -v lake exe Scripts.checkNoSorry >/dev/null 2>&1; then
            lake exe Scripts.checkNoSorry
          else
            echo "‚ö†Ô∏è  Scripts.checkNoSorry not available, using grep fallback"
            if grep -r "sorry" src/ --include="*.lean"; then
              echo "‚ùå Sorry statements found in strict mode"
              exit 1
            fi
          fi
          echo "‚úÖ No-sorry compliance verified!"
        else
          echo "‚ÑπÔ∏è  No [no-sorry] tag - skipping strict sorry check"
        fi
        echo "‚úÖ All strict build checks passed!"
        
    - name: Check for sorry statements
      run: |
        echo "Checking for sorry statements in the codebase..."
        if grep -r "sorry" src/ --include="*.lean"; then
          echo "‚ö†Ô∏è  Found sorry statements in the code"
          echo "This is expected during development - checking count..."
          SORRY_COUNT=$(grep -r "sorry" src/ --include="*.lean" | wc -l)
          echo "Current sorry count: $SORRY_COUNT"
          if [ $SORRY_COUNT -gt 50 ]; then
            echo "‚ùå Too many sorry statements (>50). Please complete some proofs."
            exit 1
          else
            echo "‚úÖ Sorry count is acceptable for development phase"
          fi
        else
          echo "üéâ No sorry statements found - proof is complete!"
        fi
        
    - name: Check no sorry (optional strict mode)
      if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[no-sorry]')
      run: |
        echo "Running strict no-sorry check..."
        if grep -r "sorry" src/ --include="*.lean"; then
          echo "‚ùå Sorry statements found but [no-sorry] mode is enabled"
          exit 1
        else
          echo "‚úÖ No sorry statements found - strict mode passed!"
        fi
        
    - name: Run basic tests
      run: |
        echo "Running basic sanity checks..."
        # Check that main theorem exists
        if grep -q "riemann_hypothesis" src/RiemannHypothesis/RiemannHypothesis.lean; then
          echo "‚úÖ Main theorem found"
        else
          echo "‚ùå Main theorem not found"
          exit 1
        fi
        
    - name: Upload build artifacts
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: |
          .lake/build/log
          *.log 